---
title: "Risk of Midlife Stroke after Adverse Pregnancy Outcomes"
date: "`r Sys.Date()`"
author: "Anni Kauko"
editor_options:
  chunk_output_type: console
output:
  html_document:
    number_sections: true
    code_folding: hide
    toc: true
    toc_float: 
        collapsed: false
        smooth_scroll: false
    theme: flatly
    highlight: haddock
    df_print: paged
---


```{r setup}

knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=F)

```


<details><summary>**Libraries**</summary>

```{r libraries, class.source = 'fold-show'}


library(tidyverse)
library(data.table) # fread() function
library(survival)   # survival analysis
library(survminer)  # ggbased visualization and extra diagnostics
library(gridExtra)  # plots to grid
library(visdat)     # visualization of tibble and na's
library(tableone)   # Characteristics table
library(kableExtra) # Pretty tables

source('scripts/functions.R')

fg_path <- "/finngen/library-red/finngen_R10"
data_path <- "data"
fig_path <- "figs"


```

</details>
<br>


# Data
<br>


## Definitions

Aim of this study is to investigate the relationship between adverse pregnancy outcomes (APO) and the time to first stroke.

**Hypothesis:** 

A history of APO will be associated with shorter time to first stroke ('early stroke'). The association between APO and early stroke will be stronger in women with >= 2 pregnancies complicated by APO (dose response).


### Includsions & exclusions

Inclusions:

- All genotyped individuals in FinnGen dataset, who's first birth was 1969 or later.

Exclusions:

- People with stroke prior to first delivery
- People with no deliveries.


### Exposures


**Primary exposure: History of adverse pregnancy outcomes (APO)** 


Variable coding/APO2:

  - 0: No APO
  - 1: APO in one pregnancy
  - 2: APO in >=2 pregnancies

Included variables:

  - Gestational hypertension* (O15_GESTAT_HYPERT) 
  - Preeclampsia - Eclampsia, O15_PRE_OR_ECLAMPSIA 
  - Preterm birth (prior to 37 weeks), (O15_PRETERM)  
  - Small for gestational age, (O15_POOR_FETGRO)
  - Placental abruption (PLAC_PREMAT_SEPAR)
  
*If I9_HYPTENS prior to O15_GESTAT_HYPERT, reclassify as O15_EXIST_HYPERT_COMPLIC. 
  
We excluded still births, as we did not have enough data available. 

Data events from 'finngen endpoint longitudinal' were combined to birth registry derived data (fields RDIAG and SDIAG).


**Secondary exposures:**

- Pregnancy induced hypertension (PIH): (0: No PIH, 1: 1 pregnancy with PIH, 2>= pregnancies with PIH).
- Each of six individual APOs. 


### Outcomes

**Primary outcome: Any stroke**

- FinnGen  variable: I9_STR_SAH
- Includes: ischemic stroke (I9_STR_EXH),  non-traumatic intracerebral hemorrhage (I9_ICH), non-traumatic subarachnoid hemorrhage (I9_SAH)
- Does not include:  transient ischemic stroke, subdural hematoma, traumatic subarchnoid hemorrage or traumatic brain injury. 
- Age is used as time scale. 


Excluded:

- Stroke associated with pregnany. (During pregnancy or one year post partum.)
- Outcome event earlier than 1 year postpartume the first birth.


**Secondary outcome: **

- Stroke in the "young": any stroke at age 
  * <= 45 years
  * <= 55 years
  * <= 65 years. 


### Covariates


**Covariates, general:**

- Age at first birth (Reproductive history data, min(MOTHER_AGE))
- Year of first birth (Reproductive history data)
- Number of births in register (Reproductive history data, max(PARITY))
- Highest education level - *ever*     (SES data)
  * Imputed by SES status

**Disease covariates, prior to stroke:**

- Chronic hypertension (I9_HYPTENS) - as time varied covariate
- Obesity (E4_OBESITY)
- Diabetes (E4_DIABETS)
- Hyperlipidemia (E4_HYPERCHOL| RX_STATIN)
- Ischaemic heart disease (I9_CHD)
- Atrial fibrillation (I9_AF)
- Chronic kidnay disease (N14_CHRONKIDNEYDIS)
- Autoimmune disorders: Lupus (M13_SLE)
- Migraine (G6_MIGRAINE)

**Incomplete - to sensitivity analysis**:

- Smoking, ever/never (Primarly from "FinnGen minimal", secondarily from the reproductive history data, if smoking during pregnancy )
- Smoked during any pregnancy (from Reproductive history data, 'SMOKING')
- BMI (Primarily we used first available measurement From Reproductive history data, secondarily we used value from "FinnGen minimal")

BMI and smoking data are incomplete and will not be included to main analysis. We will asses them in separate sensitivity analysis.


**Not available**

- Household income
- Maritial status



## Download & process data
<br>


**Variable lists**

```{r}

names_ep <- list("STR_SAH", "STR_45","STR_55", "STR_65", "STR_EXH", "STR_EMBOLIC", "STR_NEMB", "INTRACRA", "ICH", "SAH")
ep_age <-   str_replace(unlist(names_ep), "(.*)", "\\1_AGE")
nicenames_ep <- c(STR_SAH = "Stroke", STR_65 = "Stroke <65 years", STR_55 = "Stroke <55 years", STR_45 = "Stroke <45 years", 
                  STR_EXH = "Ischemic stroke", STR_EMBOLIC = "Embolic stroke", STR_NEMB <- "Non-embolic stroke", 
                  INTRACRA = "Hemorrhagic stroke", ICH = "ICH", SAH = "SAH")
                  
dis_covs <- c("OBESITY_PRE", "DIABETES_PRE", "HYPCHOL_WIDE_PRE", "CHD_PRE", "AF_PRE", "HEARTFAIL_PRE",
              "CHRONKIDNEYDIS_PRE", "SLE_PRE", "MIGRAINE_PRE")
dis_covs_ever <- str_remove(dis_covs, "_PRE")
dis_covs_age <- str_replace(dis_covs, "_PRE", "_AGE")
oth_covs <- c("AGE_FIRST", "EDUC3", "PARITY_LAST")
extr_covs <- c("PSMOKED", "SMOKED", "BMI")


apo_vars <- c("GESTAT_HYPERT", "PRE_OR_ECLAMPSIA", "PRETERM", "POOR_FETGRO", "PLAC_PREMAT_SEPAR")
pih_vars <- c("EXIST_HYPERT_COMPLIC", "GESTAT_HYPERT", "PRE_OR_ECLAMPSIA")
exp_vars <- c(pih_vars, apo_vars) %>% unique()
exp_vars_age  <-  str_replace(exp_vars, "(.*)", "\\1_AGE")
exp_vars_year <-  str_replace(exp_vars, "(.*)", "\\1_YEAR")

nicenames_exp <- c(APO2 = "Any APO", APO1 = "Any APO", PIH2 = "Any PIH", EXIST_HYPERT_COMPLIC ="Chronic HTN", GESTAT_HYPERT = "Gestational HTN", PRE_OR_ECLAMPSIA = "Preeclampsia-eclampsia", PRETERM = "Preterm birth", POOR_FETGRO="Small for gestational age", PLAC_PREMAT_SEPAR = "Placental abruption")

preg_vars <- c("HYPTENSPREG","EXIST_HYPERT_COMPLIC", "GESTAT_HYPERT", "PRE_OR_ECLAMPSIA", "PRETERM", "POOR_FETGRO", "MULTIP_GEST", "PLAC_PREMAT_SEPAR")

source_reg <- c(AGE_FIRST = "Population Registry", EDUC3="Statistics Finland", PARITY_LAST="Population Registry", 
                GESTAT_HYPERT = "Hilmo or MBR", PRE_OR_ECLAMPSIA = "Hilmo or MBR", PRETERM = "Hilmo or MBR", POOR_FETGRO = "Hilmo or MBR", 
                PLAC_PREMAT_SEPAR = "Hilmo or MBR", EXIST_HYPERT_COMPLIC = "Hilmo or MBR", GESTAT_HYPERT = "Hilmo or MBR", 
                PSMOKED="MBR", SMOKED="MBR or Biobanks", BMI="MBR or Biobanks", STR_SAH_AGE="Hilmo",
                OBESITY_PRE="Hilmo", DIABETES_PRE="Hilmo", HYPCHOL_WIDE_PRE="Hilmo", CHD_PRE="Hilmo", HYPTENS_1BR = "Hilmo", HYPTENS_PRE = "Hilmo",
                AF_PRE="Hilmo", HEARTFAIL_PRE="Hilmo", CHRONKIDNEYDIS_PRE="Hilmo", SLE_PRE="Hilmo", MIGRAINE_PRE="Hilmo")

```


### Download and preprocess
<br>

**Copy and preprocess outside the R**

Endpoint and covariate files are transfered and unzipped. Columns are selected from endpoint file prior to import to R, because the original phenotype file is very large.

```{bash, eval=F}

phenodir="/finngen/library-red/finngen_R10/phenotype_1.0/data"

zcat $phenodir/finngen_R10_endpoint_1.0.txt.gz > data/finngen_R10_endpoint_1.0.txt
perl scripts/select_columns.pl data/finngen_R10_endpoint_1.0.txt data/finngen_R10_str_preg.txt data/fg_pheno_cols.txt  &
wait
rm data/finngen_R10_endpoint_1.0.txt

zgrep -E 'O15_|P16_|I9_STR_SAH|FINNGENID'  $phenodir/finngen_R10_endpoint_longitudinal_1.0.txt.gz > data/R10_longitudinal_preg.txt &

zgrep -E 'DEATH|FINNGENID'  $phenodir/finngen_R10_detailed_longitudinal_1.0.txt.gz > data/R10_longitudinal_death.txt &

```

<br>

**Load and combine the data**

```{r load & combine}


#ICD-codes for birth registry derived variables
icd_in <- fread(str_glue("{data_path}/icd_codes_preg.csv"))

#birth_register
birth_reg <- fread(str_glue("{fg_path}/birth_and_dvv_register_1.0/data/finngen_R10_birth_dvv_register_mothers.txt.gz")) %>%
  rename(FINNGENID = MOTHER_FINNGENID) 

#ses-data
ses <- fread("/finngen/pipeline/finngen_R10/socio_register_1.0/data/finngen_R10_socio_register.txt.gz") %>%
  mutate_at(c("SOURCE", "CODE1", "CODE2", "CATEGORY"), as.factor) 

#Individuals from birth registry are selected for this study
ids <- birth_reg %>%
  select(FINNGENID) %>% 
  distinct()

#Unique pregnancies from birth registry
 pregs <- birth_reg %>%
  select(FINNGENID, MOTHER_AGE, BIRTH_YEAR, PARITY) %>%
  distinct() 
 

#Finngen 'endpoint' file
vars_ep <- fread(str_glue("{data_path}/finngen_R10_str_preg.txt"), sep = "\t") %>%
  #Change NA -> 0 for disease variables. 
  #FinnGen data is constructed for GWASes, where similar diseases need to be removed from controls. This does not apply to present study
  mutate_at(vars(-FINNGENID, -ends_with("_AGE"), -ends_with("_YEAR")), ~if_else(is.na(.), 0L, .))

#Finngen 'minimum' file
phenomin <- fread(str_glue("{fg_path}/phenotype_1.0/data/finngen_R10_minimum_1.0.txt.gz")) %>%
  select("FINNGENID", contains("BL_"), "SEX", contains("HEIGHT"), contains("WEIGHT"), "SMOKE3", "SMOKE_AGE", "movedabroad", "NUMBER_OF_OFFSPRING")

#Endpoint and minimum files combined to id-list of birth registry women
df0 <- ids %>%
  left_join(phenomin, by = "FINNGENID") %>%
  left_join(vars_ep, by = "FINNGENID")

#Finngen 'endpoint longitudinal' file - used for exposures together with birth register
long_in <- fread(str_glue("{data_path}/R10_longitudinal_preg.txt")) %>%
  mutate(ENDPOINT=str_replace(ENDPOINT, "^[OP]1._", "")) %>%
  mutate(ENDPOINT=str_replace(ENDPOINT, "^C_", "")) %>%
  mutate_at(c("EVENT_TYPE","ICDVER","ENDPOINT"),as.factor)

#Deaths from detailed longitudinal:
death_in <- fread(str_glue("{data_path}/R10_longitudinal_death.txt")) %>%
  #slice(1:500) %>%
  filter(SOURCE=="DEATH") %>%
  filter(str_detect(CATEGORY, "I|U")) %>%
  #CVD deaths selected
  filter((ICDVER == 10 & str_detect(CODE1, "^I"))|
         ((ICDVER == 9 | ICDVER == 8) & str_detect(CODE1, "^39|^4[1-5]"))) 

```


**Preprocessing FinnGen variables**

Selecting and prosessing variables from 'FinnGen endpoint' file. 

```{r}

#First CVD death to wide format
cvd_death <- death_in  %>%
  mutate(CVD_DEATH = 1L, CVD_DEATH_AGE = EVENT_AGE) %>%
  select(FINNGENID, contains("CVD_DEATH")) %>%
  distinct()
  


#Data preprocessed
df <- df0 %>%
  
  #Names are shortened (icd/finngen prefix is removed)
  rename_at(vars(matches("^[A-Z][0-9]+_")), list(~str_remove(., "^[A-Z][0-9]+_"))) %>%
  rename_at(vars(starts_with('XV_')), list(~str_remove(., "XV_"))) %>%
  rename_at(vars(starts_with('C_')), list(~str_remove(., "C_"))) %>%
  rename_at(vars(starts_with('RX_')), list(~str_remove(., "RX_"))) %>%
  
  #Remove individual with no "FU_END_AGE" i.e. individuals missing from endpoint-file
  filter(!is.na(FU_END_AGE)) %>%

  #Additional outcome variabes defined 
  mutate(STR_65   = if_else(STR_SAH   == 1 & STR_SAH_AGE < 65,   1L, 0L), 
         STR_55   = if_else(STR_SAH   == 1 & STR_SAH_AGE < 55,   1L, 0L),         
         STR_45   = if_else(STR_SAH   == 1 & STR_SAH_AGE < 45,   1L, 0L),           
         STR_NEMB = if_else(STR_EXH  == 1 & STR_EMBOLIC == 0,  1L, 0L),
         STR_NEMB_AGE = if_else(STR_NEMB == 1, STR_EXH_AGE,  FU_END_AGE),
  )%>%
  rowwise() %>%
    mutate(STR_65_AGE   = if_else(STR_65   == 1, STR_SAH_AGE,   min(FU_END_AGE,65)),
           STR_55_AGE   = if_else(STR_55   == 1, STR_SAH_AGE,   min(FU_END_AGE,55)),
           STR_45_AGE   = if_else(STR_45   == 1, STR_SAH_AGE,   min(FU_END_AGE,45))) %>%
  ungroup() %>%
  mutate_at(c("STR_65", "STR_55", "STR_45", "STR_NEMB"), as.integer) %>%

  #smoking: ever-never according phenotype minimal file
  mutate(SMOKED_FG = if_else(SMOKE3 == "never", 0L, 1L)) %>%
  
  #BMI according phenotype minimal file
  mutate(BMI_FG = WEIGHT /(HEIGHT*1e-2)^2) %>%
  
  #Wider definition of hypercholesterolaemia, includes also statin medication
  mutate(HYPCHOL_WIDE = if_else(HYPERCHOL == 1 | STATIN ==1, 1L, 0L)) %>% 
  rowwise() %>%
    mutate(HYPCHOL_WIDE_AGE = min(HYPERCHOL_AGE, STATIN_AGE)) %>%
  ungroup() %>%

  #If hypertension before gestational hypertension, move gestational hypertension to 'existing hypertension complicating pregnancy'
  mutate(EXIST_HYPERT_COMPLIC = if_else(HYPTENS_AGE < GESTAT_HYPERT_AGE & GESTAT_HYPERT == 1, 1L, EXIST_HYPERT_COMPLIC),
         EXIST_HYPERT_COMPLIC_AGE = if_else(HYPTENS_AGE < GESTAT_HYPERT_AGE & GESTAT_HYPERT == 1, GESTAT_HYPERT_AGE, EXIST_HYPERT_COMPLIC_AGE),
         GESTAT_HYPERT = if_else(HYPTENS_AGE < GESTAT_HYPERT_AGE, 0L, GESTAT_HYPERT),
         GESTAT_HYPERT_AGE = if_else(HYPTENS_AGE < GESTAT_HYPERT_AGE, FU_END_AGE, GESTAT_HYPERT_AGE)) %>%
  
  #cvd deaths joined to dataset
  left_join(cvd_death, by = "FINNGENID") %>%
  mutate(CVD_DEATH     = if_else(is.na(CVD_DEATH), 0L, CVD_DEATH),
         CVD_DEATH_AGE = if_else(is.na(CVD_DEATH_AGE), FU_END_AGE, CVD_DEATH_AGE))
  
  
```


### Covariates
<br>

**Covariates from reproductive data**


```{r}

#BMI fromn first birth with recorded BMI
bmi_br <- birth_reg %>%
  select(FINNGENID, MOTHER_AGE, MOTHER_WEIGHT, MOTHER_HEIGHT, PARITY) %>%
  mutate(BMI_BR = MOTHER_WEIGHT /(MOTHER_HEIGHT*1e-2)^2) %>% 
  filter(!is.na(BMI_BR)) %>%     #Only births with recorded BMI
  group_by(FINNGENID) %>%
  slice(which.min(MOTHER_AGE)) %>%  #Select first birth from births with recorded mother BMI
  ungroup() %>%
  select(FINNGENID, BMI_BR)

#Other covariates
br_covs <- birth_reg %>% 
  mutate(PSMOKE_TMP = case_when(SMOKING == 2 | SMOKING == 3 | SMOKING == 4 ~ 1L,   #any smoking during pregnancy
                                SMOKING == 1 ~ 0L,                                 #no smoking  
                                TRUE ~ -1L)) %>%    #To prevent NA spread at 'summarise-max'. Its enough to have recorded
  group_by(FINNGENID) %>%                           #value from one pregnancy
  summarise(AGE_FIRST = min(MOTHER_AGE), YEAR_FIRST = min(BIRTH_YEAR), NRO_CHILD, FETUSES_MAX = max(NRO_FETUSES), 
            PARITY_FIRST = min(PARITY), PARITY_LAST = max(PARITY),
            PSMOKED = max(PSMOKE_TMP) ) %>% 
  filter(PARITY_FIRST == 1) %>% #Women included only if also the first pregnancy is included in the register
  distinct() %>%  
  mutate(PSMOKED = if_else(PSMOKED == -1L, NA_integer_, PSMOKED),
         PSMOKED = as.factor(PSMOKED)) %>%
  left_join(bmi_br, by="FINNGENID")

```


**Educational data**

When SOURCE==EDUC, CODE2 represents 'kaste_t2' data for level of education. 

We will take the highest education level an individual reaches during life - more
than third of individuals do not have recorded education level before the first birth.


```{r}
#kaste_t2:
#0 Early childhood education
#1 Primary education
#2 Lower secondary education
#3 Upper secondary education
#4 Post-secondary non-tertiary education
#5 Short-cycle tertiary education
#6 Bachelor's or equivalent level
#7 Master's or equivalent level
#8 Doctoral or equivalent level
#9 Not elsewhere classified

educ <- ses %>%
  filter(CATEGORY == "EDUC") %>%
  right_join(select(br_covs, FINNGENID, AGE_FIRST), by = "FINNGENID") %>%
  #filter(EVENT_AGE < AGE_FIRST) %>%   
  #mutate(DIFF = AGE_FIRST - EVENT_AGE) %>% 
  mutate(EDUC = as.integer(str_sub(CODE2, 1,1))) %>%
  group_by(FINNGENID) %>%
      slice(which.max(EDUC)) %>% 
      #slice(which.max(EVENT_AGE)) %>%  
  ungroup()  %>%
  rename(EDUC_YEAR = YEAR, EDUC_AGE = EVENT_AGE) %>%

  mutate(EDUC3 = case_when(EDUC <= 3 ~ "secondary",
                           EDUC == 4 | EDUC == 5 ~ "post-secondary", 
                           EDUC > 5 ~ "higher")) %>%
  mutate(EDUC3 = factor(EDUC3, levels = c("secondary", "post-secondary", "higher"))) %>%
  mutate_at(c("EDUC"), as.factor) %>%
  select(FINNGENID, EDUC, EDUC3, EDUC_YEAR, EDUC_AGE) 

summary(educ)  


  
```

**SES status for imputation of education**

```{r}
sose <- ses %>%
  #slice(1:1000) %>%
  filter(CATEGORY == "SOSE")  %>% #summary()
  mutate(SOSE = case_when(str_detect(CODE1, "^1|^2") | str_detect(CODE2, "^1|^2") ~ "1",
                          str_detect(CODE1, "^3") | str_detect(CODE2, "^3") ~ "3",
                          str_detect(CODE1, "^4") | str_detect(CODE2, "^4") ~ "4",
                          str_detect(CODE1, "^5") | str_detect(CODE2, "^5") ~ "5",
                          str_detect(CODE1, "^7") | str_detect(CODE2, "^6") ~ "6",
                          str_detect(CODE1, "^6") | str_detect(CODE2, "^7") ~ "7",
                          str_detect(CODE1, "^9") | str_detect(CODE2, "^8") ~ "8") 
         %>% as.factor) %>%
  mutate(DIFF_50 = abs(50-EVENT_AGE)) %>%
  group_by(FINNGENID) %>%
      slice(which.min(DIFF_50)) %>% 
  ungroup() %>%
  rename(SOSE_YEAR = YEAR, SOSE_AGE = EVENT_AGE) %>%
  select(FINNGENID, contains("SOSE"))
  

```


**Combine to main data **

```{r}
df <- df %>% 
  left_join(br_covs, by="FINNGENID") %>% 
  left_join(educ, by="FINNGENID") %>%
  left_join(sose, by="FINNGENID") %>%
  
  #select(contains("SMOKE"), contains("BMI")) %>%
  #We use primarly birth registry bmi and secondarily values from 'finngen minimum'
  mutate(BMI = if_else(is.na(BMI_BR), BMI_FG, BMI_BR)) %>%
  #We use primarly value derived from 'finngen minimum', but if person has smoked
  #during pregnancy, she has smoked. Smoking during pregnancy is also separate variable.
  mutate(SMOKED = if_else(PSMOKED == 0 | is.na(PSMOKED), SMOKED_FG, 1L)) %>%
  mutate_at(c("SMOKED_FG","SMOKED","PSMOKED"), as.factor) %>%
  #Educational data: ~10 % missing, frequent category imputation using birth year and SES status
  mutate(BR_YEAR = as.integer(round(YEAR_FIRST - AGE_FIRST, 0)))%>%
  #Create variable for hypertension at the time of first birth 
  mutate(HYPTENS_1BR = if_else(HYPTENS == 1 & HYPTENS_AGE < AGE_FIRST, 1L, 0L) )


```



### Exclusions



**All FinnGen individuals**

```{r}
dim(phenomin)
```

**All births**

```{r}
dim(pregs)
```


**FinnGen individuals with reproductive history data as mothers**

```{r}
dim(ids)
```


**FinnGen individuals, who have hospital discharge data _and_ reproductive history data as mothers**
```{r}
dim(df)
```


**Remove persons FinnGen followup ends within one year of first birth**

Remove if FU_END_AGE < AGE_FIRST + 1. FU_END_AGE is FinnGen's followup (death, moving abroad or year 2020). One year is added,
because also outcomes are counted one year after first birth.


```{r}

df_tmp1 <- df %>% 
  #REMOVE person if  FU_END_AGE < AGE_FIRST + 1  (This also removes DEATH from this time period.)
  filter(FU_END_AGE - AGE_FIRST >= 1) 

dim(df_tmp1)

```


**Remove persons with first birth before year 1969 **

Our clinical data starts from this year. 


```{r}
df_tmp2 <- df_tmp1 %>%
  #REMOVE person, if FIRST BIRTH birth BEFORE year 1969 - our clinical data starts from this year. 
  #REmoves also cases where YEAR_FIRST is not defined i.e. not birth register
  filter(YEAR_FIRST >= 1969) 

dim(df_tmp2)
```


**Remove persons if stroke before the first birth**


```{r}
df_tmp3 <- df_tmp2 %>%
  filter(AGE_FIRST < STR_SAH_AGE)
dim(df_tmp3)
```


**Individual was removed if stroke during *any* pregnancy or in the first year post partum. **


```{r}

str.tmp <- 
  pregs %>%  #All births 
  left_join(select(df, c("FINNGENID", "STR_SAH", "STR_SAH_AGE", "FU_END_AGE")), by="FINNGENID") %>% #stroke added
  #mutate(STR_SAH_DIFF = STR_SAH_AGE - MOTHER_AGE) %>% #time difference: birth_age and stroke
  #Stroke during pregnancy or in the first year post partum are removed. 
  mutate(STR_SAH_NA = if_else(STR_SAH == 0 | STR_SAH_AGE - MOTHER_AGE < -0.75 | STR_SAH_AGE - MOTHER_AGE > 1, STR_SAH, NA_integer_)) %>%
  select(FINNGENID, STR_SAH_NA) %>% 
  distinct() %>%
  group_by(FINNGENID) %>%
    summarise(STR_SAH_NA = max(STR_SAH_NA)) %>%   #Actual purpose is to always select NA, if repeated rows are present. 
  ungroup()                                    #Numeric values are identical for repeated rows; this is not really max.

#Filtered outcomes are joined back to the main data frame.
df_tmp4 <- df_tmp3 %>%
  left_join(str.tmp, by="FINNGENID") %>%
  #select(contains("STR_SAH")) %>%
  filter(!is.na(STR_SAH_NA))
  
dim(df_tmp4)
```


**Missing education values are imputed and combined to data**

We imputed education based on variable "SOSE" and birth decade. 
Frequent category imputation was used. "SOSE" represents sosio-economic 
class such as worker, student, higher professional etc. Individuals with
neither EDU3 nor SOSE were excluded.


```{r}

edu.imp.table <- df %>% 
  select(FINNGENID, contains("EDUC"), contains("SOSE"), BR_YEAR) %>%
  mutate(BR_DEC = floor(BR_YEAR/10)*10) %>% 
  #slice(1:50) %>%  #filter(BR_DEC==1980) %>% #filter(SOSE==5)%>% 
  group_by(BR_DEC, SOSE) %>% 
  summarise(EDUC_IMP = getmode(EDUC3, na.rm=T)) %>% 
  filter(!is.na(SOSE) & !is.na(EDUC_IMP)) 

df_tmp5 <- df_tmp4 %>% 
  #Imputed education added to table
  mutate(BR_DEC = floor(BR_YEAR/10)*10) %>%
  left_join(edu.imp.table, by=c("SOSE", "BR_DEC")) %>%
  #Missing values replaced
  mutate(IS_EDUC_IMP = if_else(is.na(EDUC3) & !is.na(EDUC_IMP), 1L, 0L) %>% as.factor(),
         EDUC3 = if_else(is.na(EDUC3) & !is.na(EDUC_IMP), EDUC_IMP, EDUC3))

df_tmp5 %>% select(contains("EDUC"), contains("SOSE"), "BR_DEC") %>% summary()

#Remove individuals to whom educational level was not present nor imputated
df <- df_tmp5 %>% filter(!is.na(EDUC3))
dim(df)
```

**Births in final data**

```{r}
pregs_tmp <- df %>%
  left_join(pregs, by="FINNGENID")

dim(pregs_tmp)

```


<br>


### Exposures
<br>

**We combine information** from medical birth registry (starts at 1987) and 
hospital discharge registry (starts at 1969). 


**ICD-code table for the birth registry.**

All (except still birth) are based on FinnGen variable definition. 


```{r}
icd_in %>% 
  mutate_all(as.character) %>%
  #Extra spaces to prevent conversion of "^" to exponents by knitr
  mutate_at(c("ICD_10","ICD_9", "ICD_8", "EXCLUDE"),~str_replace_all(.,'\\|','| ')) %>%
  select(-NA_limit) %>%  
  my.kable()

```

**Extract ICD codes from birth registry**

```{r}



conds <- icd_in %>% 
  split(f = as.factor(.$NAME))
dis_list <- names(conds) %>% as.list()

diag.tmp <-
  birth_reg %>%
    select(FINNGENID, MOTHER_AGE, PARITY, BIRTH_YEAR,  contains("SDIAG"),contains("RDIAG")) %>%
    pivot_longer(SDIAG1:RDIAG10, names_to = "names", values_to = "DIAG") %>%
    mutate_at(vars(contains("DIAG")), as.factor)

diag.list <- 
  lapply(dis_list, function(var_name){
    
    #Conditions for variables
    #var_name = "PRETERM"
    cond_icd10 = conds[[var_name]]$ICD_10 
    cond_icd9  = conds[[var_name]]$ICD_9 
    cond_icd8  = conds[[var_name]]$ICD_8
    exclude = conds[[var_name]]$EXCLUDE

    diag.tmp %>%
      #filter(str_detect(DIAG, "O13|^6423|^63701")) %>%
      filter( BIRTH_YEAR >= 1996 & str_detect(DIAG, cond_icd10)|
             (BIRTH_YEAR >= 1987 & BIRTH_YEAR <= 1995 & str_detect(DIAG, cond_icd9)  )|
             (BIRTH_YEAR >= 1967 & BIRTH_YEAR <= 1986 & str_detect(DIAG, cond_icd8)) ) %>%
      filter(!str_detect(DIAG, exclude)) %>%
      mutate_at(c("names","DIAG"), as.factor) %>%
      mutate_at(c("names","DIAG"), fct_drop) %>%
      mutate(ENDPOINT = as.factor(var_name), EVENT_AGE = MOTHER_AGE, EVENT_YEAR = BIRTH_YEAR) %>%
      select(FINNGENID, ENDPOINT, EVENT_AGE, EVENT_YEAR, DIAG, PARITY) %>%
      distinct() 

})%>% setNames(dis_list)

#bind_rows(diag.list) %>%  summary()
 

```



<details><summary> Number of ICD codes for each variable</summary>
<br>

These values are per individual. Codes have been grouped by first three letters. Values have been removed if n<5 or if there was more than 30 lines.

```{r, nr icds, results="asis"}

lapply(dis_list, function(myvar){
  
  diag.list[[myvar]] %>%
    group_by(FINNGENID) %>%
      slice(which.min(EVENT_AGE)) %>%   #filter(EVENT_AGE == min(EVENT_AGE)) would leave ties...
    ungroup()  %>%
    mutate_at("DIAG", as.character) %>%
    group_by(DIAG) %>%
    summarise(n=n(), mean_age=round(mean(EVENT_AGE),1), mean_year=round(mean(EVENT_YEAR),0)) %>%
    ungroup() %>%
    arrange(desc(n)) %>%
    filter(n >= 5) %>%
    slice(1:30) %>%
    as.data.frame() %>%
    knitr::kable() %>%
    kable_classic(full_width=F,font_size = 12) %>%
    row_spec(0,bold=TRUE) %>%
    add_header_above(c(set_names(4,myvar)), bold=T)
})

```

</details>
<br>


**Exposures combined**

First we create longitudinal file where birth registry and hospital discharge data are combined.
Then we replace values of EVENT_AGE and EVENT_YEAR with MOTHER_AGE and BIRTH_YEAR from
birth registry (set as same pregnancy if abs(MOTHER_AGE - EVENT_AGE) < 0.75). 
Resulting file is similar to *'endpoint longitudinal'* file, except it has also parity. 
Birth registry contained only ~1/3 of entries when compared to full hospital discharge register. **We exctract data from both registries and combine them.** 

For 'small gestational age we use FinnGen variable 'POOR_FETAL_GROWTH', because 
child information is included only for handfull of kids with their own individual CHILD_FINNGENID. Also datafield for still birth was not included FinnGen's version of birth register, so we were not able to include it.


```{r}


exp_birth <- bind_rows(diag.list) %>% 
  #Exposure variables selected
  filter(ENDPOINT %in% exp_vars) %>%
  mutate(ENDPOINT = droplevels(ENDPOINT)) %>%
  #Formatted to 'endpoint longitudinal' format
  mutate(EVENT_TYPE = as.factor("BIRTH")) %>% 
  mutate(ICDVER = case_when(EVENT_YEAR >= 1996 ~ 10,
                            EVENT_YEAR >= 1987 & EVENT_YEAR <= 1995 ~ 9,
                            EVENT_YEAR >= 1967 & EVENT_YEAR <= 1986 ~8) %>% as.factor() ) %>%
  select(-DIAG)
    

exp_long <- long_in %>%
  as_tibble() %>%
  #Exposure variables selected
  filter(ENDPOINT %in% exp_vars) %>%
  mutate(ENDPOINT=droplevels(ENDPOINT))%>%
  #Births joined to events
  left_join(pregs, by = "FINNGENID") %>%
  mutate(AGE_DIFF = abs(MOTHER_AGE - EVENT_AGE)) %>%
  filter(AGE_DIFF < 0.75) %>%
  mutate(EVENT_AGE = MOTHER_AGE, EVENT_YEAR = BIRTH_YEAR) %>%
  select(-"MOTHER_AGE", -"BIRTH_YEAR", -"AGE_DIFF")

#Two data sources combined
exp_both <- bind_rows(exp_birth, exp_long) %>%
  arrange(FINNGENID, EVENT_AGE) %>%
  distinct

```


**Subvariables to wide format**

```{r}

exp_detailed <- lapply(as.list(exp_vars), function(var){
  
  exp_both %>% 
    create_3level_var(var)
  
}) %>%
  reduce(full_join, by="FINNGENID") %>% 
  distinct() %>% 
  mutate_at(all_of(exp_vars), ~if_else(is.na(.), 0L, .)) %>%
  mutate_at(all_of(exp_vars), as.factor) 



```



<details><summary> Test: Data from both registries compared.</summary>
<br>

**Correlations and cross tables for birth register and longitudinal data:**

```{r}

test_exp <-    #Here all pregnancies are included to correlation
  pregs %>% 
  left_join(exp_both) %>%
  mutate(EVENT_TYPE = if_else(is.na(EVENT_TYPE), "-", as.character(EVENT_TYPE)),
         birth = if_else(EVENT_TYPE == "BIRTH", 1, 0), 
         long = if_else(EVENT_TYPE %in% c("HILMO","ERIK_AVO","DEATH"), 1, 0)) %>%
  group_by(FINNGENID) %>%
  summarise(birth = max(birth), long = max(long)) 

#print("correlation:")
cor(test_exp$birth, test_exp$long)
#print("table, birth registry vs. longitudinal data:")
table(test_exp$birth, test_exp$long)

```

Mostly birth register derived variables are subset of hospital discharge derived variables, but we get ~500 extra cases, when we include also birth register.

<br>

**All events in all pregnancies.**

```{r}
exp_both %>% 
  mutate(EVENT_TYPE = if_else(EVENT_TYPE != "BIRTH", "LONGIT", "BIRTH")) %>% 
  mutate_at(c("ENDPOINT", "PARITY", "EVENT_TYPE"), as.factor) %>% 
  summary()
```
<br>

**All unique events in all pregnancies**

Overlapping entries in birth register and longitudinal data removed.

```{r}

exp_both %>% 
  #filter(ENDPOINT %in% apo_vars) %>%
  mutate_at(c("ENDPOINT", "PARITY", "EVENT_TYPE"), as.factor) %>% 
  select(-EVENT_TYPE) %>% distinct %>%
  summary()
```
<br>

**Final variables**

```{r}
exp_detailed %>% summary()
```

</details>
<br>



**History of adverse pregnancy outcomes (APO) defined**


```{r}

apo <- exp_both %>%
  create_3level_var("APO2", apo_vars) %>%
  mutate_at("APO2", as.factor)


```


**History of hypertensive disorder of pregnancy (PIH) defined** 


```{r}


pih <-  exp_both %>%
  create_3level_var("PIH2", pih_vars) %>%
  mutate_at("PIH2", as.factor)

```


**Combined all exposure variables**

If exposure is not found, it is set as '0'. 

```{r}

exposures <- ids %>%
  left_join(apo, by = "FINNGENID") %>%
  left_join(pih, by = "FINNGENID") %>%
  mutate(APO1 = if_else(APO2 == 1 | APO2 == 2, 1L, 0L)) %>%
  left_join(exp_detailed, by="FINNGENID") %>%
  mutate_at(c("APO2", "PIH2", "APO1", all_of(exp_vars)), as.character) %>%
  mutate_at(c("APO2", "PIH2", "APO1", all_of(exp_vars)), ~if_else(is.na(.), "0", .)) %>%
  mutate_at(c("APO2", "PIH2", "APO1", all_of(exp_vars)), as.factor) 

```



<details><summary> Test: Compare new exposure variables to corresponding variables in 'FinnGen' longitudinal</summary>
<br>


```{r}

# NA in <exposure>_AGE is not changed - perhaps first birth could be used, if reference values are really needed.

tmpx <- str_replace(exp_vars, "(.*)", "\\1.x")[-1]
tmpy <- str_replace(exp_vars, "(.*)", "\\1.y")[-1]

tmp <- df %>% 
  left_join(exposures, by="FINNGENID") %>% 
  select(all_of(tmpx), all_of(tmpy)) %>%
  mutate_at(all_of(tmpy), ~if_else(.==1, 1L, 0L))
  
tmp %>% 
  mutate_all(as.factor) %>%
  summary()

lapply(as.list(exp_vars[-1]),function(var){
   cor(as.numeric(tmp[[str_glue("{var}.x")]]),as.numeric(tmp[[str_glue("{var}.y")]]), use="complete.obs")
}) %>% setNames(exp_vars[-1])

lapply(as.list(exp_vars[-1]),function(var){
   table(as.factor(tmp[[str_glue("{var}.x")]]),as.factor(tmp[[str_glue("{var}.y")]]))
}) %>% setNames(exp_vars[-1])


```

Very similar...

</details>
<br>

**Exposures added to main table.**

```{r}
df <- df %>%
  select(-any_of(exp_vars), -any_of(exp_vars_age), -any_of(exp_vars_year)) %>%   #Remove values from 'endpoint file' similarity checked below.
  left_join(exposures, by="FINNGENID")  

```


### Outcomes
<br>

We remove each outcome before the first birth and each disease covariate after a given outcome and do minor processing.

Hypertension is treated as **time dependent covariate** in some of the models. We also preprocess data by tmerge for that.


```{r}

df.str.tmp <- df %>% 

  #Create variable for lenth of followup: from first pregnancy to outcome (or end of followup)
  #(We have excluded allready earlier cases before first birth, during pregnancy or one year postpartum.)
  mutate(TIME = STR_SAH_AGE - AGE_FIRST ) %>%     
  #STR_SAH and its subvariables as integer - needed for some tables
  mutate_at(unlist(names_ep), ~as.integer(as.character(.))) %>%
  
  #Include only disease covariates before outcome  
  mutate(across(all_of(c(dis_covs_ever, "HYPTENS")), 
              list(PRE=~if_else(get(str_glue("{cur_column()}_AGE")) >= STR_SAH_AGE & !is.na(.), 0L, .)))
        ) %>%
  mutate_at(c(dis_covs, dis_covs_ever, "HYPTENS", "HYPTENS_PRE"), as.factor) 


#tmerge for time varied covariate
df.str      <- tmerge(data1=df.str.tmp, data2=df.str.tmp, id=FINNGENID, tstart = AGE_FIRST, tstop = STR_SAH_AGE)
df.str.tdc  <- tmerge(data1=df.str,     data2=df.str.tmp, id=FINNGENID, HT_TDC = tdc(HYPTENS_AGE), STR_SAH = event(STR_SAH_AGE, STR_SAH)) 

#df.str.tdc %>% summary

```


```{r, echo=F, eval=F}

#Tests for tmerge

cluster = "FINNGENID"  
covs_tmp <- c("AGE_FIRST","YEAR_FIRST","PARITY_LAST","EDUC3")

test <- df.str %>%
 # slice(20:35) %>%
 # slice(1:100) %>%
  slice(1:100000) %>%
  select("FINNGENID", contains("STR"), contains("APO2"), all_of(covs_tmp), contains("HYPTENS")) #%>% filter(STR_SAH==1)

test1     <- tmerge(data1=test, data2=test, id=FINNGENID, tstop = STR_SAH_AGE)
test2.nev <- tmerge(data1=test1, data2=test, id=FINNGENID, HT_TDC = tdc(HYPTENS_AGE))
test2     <- tmerge(data1=test1, data2=test, id=FINNGENID, HT_TDC = tdc(HYPTENS_AGE), STR_SAH_TEST = event(STR_SAH_AGE, STR_SAH))
test2.str <- test2 %>% filter(STR_SAH==1)
test2.nev %>% mutate_at(c("STR_SAH", "HT_TDC"), as.factor) %>% summary
test2      %>% mutate_at(c("STR_SAH", "STR_SAH_TEST","HT_TDC"), as.factor) %>% summary

#my_formula <- str_glue("Surv(tstart, tstop, STR_SAH)      ~ APO2 + HT_TDC")
#my_formula <- str_glue("Surv(tstart, tstop, STR_SAH)      ~ APO2 + HT_TDC + {covs_tmp}")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH_TEST) ~ APO2 + HT_TDC + {covs_tmp}")

#cx.test <- coxph(as.formula(my_formula), data=test2, cluster=id)
cx.test <- coxph(as.formula(my_formula), data=test2)
cx.test %>% summary()


```



## Characteristics


**Followup time**

All

```{r}

df.str %>% 
  select(STR_SAH_AGE, AGE_FIRST) %>% 
  mutate(FU_TIME = STR_SAH_AGE- AGE_FIRST) %>%
  summarise(sum_person_years = sum(FU_TIME), median_fu_time = median(FU_TIME))

```

Grouped by APO2

```{r}

df.str %>% 
  select(STR_SAH_AGE, AGE_FIRST, APO2) %>% 
  mutate(FU_TIME = STR_SAH_AGE- AGE_FIRST) %>%
  group_by(APO2) %>%
  summarise(sum_person_years = sum(FU_TIME), median_fu_time = median(FU_TIME))

```

 
**Preprocessing data for the characteristics table**


```{r}

df_tmp <- df.str %>%
  mutate_at(all_of(c(dis_covs, "HYPTENS", "HYPTENS_PRE", "HYPTENS_1BR")), ~if_else(.==1, "Yes", "No")) %>%
  #mutate_at("STR_SAH", ~if_else(.==1, "Yes", "No")) %>%
  #mutate_at("STR_SAH", as.factor) %>%
  mutate_at(all_of(c(dis_covs, "HYPTENS", "HYPTENS_PRE", "HYPTENS_1BR")), as.factor)
  levels(df_tmp$APO2) <- c("No APO","1 APO", "2+ APO")
  levels(df_tmp$PIH2) <- c("No PIH","1 PIH", "2+ PIH")
  

```


**Distributions**

Age and year of pregnancy and length of follow up (death, STR_SAH or year 2020).

```{r, fig.width=10, fig.height= 3 }

p1 <- df.str %>%
ggplot(aes(x=AGE_FIRST, fill=APO1, col=APO1)) +
  geom_histogram( alpha=0.4, position = 'identity', bins=10)


p2 <- df.str %>%
ggplot(aes(x=YEAR_FIRST, fill=APO1, col=APO1)) +
  geom_histogram( alpha=0.4, position = 'identity', bins =10) +
  xlim(1969, 2020)


p3 <-  df.str %>%
ggplot(aes(x=TIME, fill=APO1, col=APO1)) +
  geom_histogram( alpha=0.4, position = 'identity', bins=10) +
  xlim(0,53)
    
grid.arrange(p1,p2,p3,ncol=3)

```

<br>

### Table 1: Covariates 

<br>

```{r}

#Column names: Overall, No APO, 1 APO, >=2 APO, P value                  
myvars <- c(oth_covs, extr_covs, "HYPTENS_1BR", "HYPTENS_PRE", dis_covs, "STR_SAH_AGE")
fact_vars <- c("EDUC3", "PSMOKED", "SMOKED", "HYPTENS_1BR", "HYPTENS_PRE", dis_covs)
nonnormal_cvars <- c("STR_SAH_AGE")


#Missingness extracted
missing <- df_tmp %>% 
  select(all_of(myvars)) %>% 
  #summarise_all(~mean(is.na(.))*100) %>%
  summarise_all(~sum(is.na(.))) %>%
  pivot_longer(cols=everything(), values_to = "missing", names_to="name_tmp") %>%
  mutate(missing =  as.character(missing)) #as.character(round(missingness, 1)))
  

#The characteristics table
my_char_table(df_tmp, myvars, fact_vars, "APO2", nonnormal=nonnormal_cvars) %>%
  as.data.frame() %>%
  rownames_to_column(var = "name") %>%
  mutate(name_tmp = word(name, 1)) %>%
  #The column for missingness added
  left_join(missing, by="name_tmp") %>%
  mutate(registry=source_reg[name_tmp]) %>%
  select(-name_tmp) %>%
  mutate(missing = if_else(is.na(missing), "", missing)) %>%
  my.kable()


```

<br>


### Table 2: Outcomes

<br>


```{r}

#chr_rownames2 <- c("n", "Follow up (stroke), years", "Any stroke (%)", "Ischemic stroke (%)", "- Embolic (%)", "- Non-embolic (%)", "Hemorrhagic stroke (%)", "- ICH (%)", "- SAH (%)", "Stroke <= 65 years (%)", "Stroke death (%)", "Death (%)")   
# No APO, 1 APO, >=2 APO, P value       

lapply(names_ep, function(ep){
  bind_cols(Outcome=ep, my_table_line(df_tmp, "APO2", ep))
}) %>% 
  setNames(names_ep) %>%
  do.call(bind_rows, .) %>%
  #filter(Outcome != "STR_EMBOLIC") %>% 
  my.kable()
  

```


<br>


### Figure 3.

Median age at stroke histogram figure.

```{r}
plot.hist.str <- 
  df.str %>%
  mutate(APO2 = fct_recode(APO2, "No APO" = "0", "1 APO" = "1", "2+ APO" = "2")) %>% 
  filter(STR_SAH==1) %>%
  ggplot(aes(x=STR_SAH_AGE,fill=APO2, col=APO2)) +
  geom_histogram(alpha=0.4, position="stack", bins=15) +
  geom_vline(xintercept = median(df.str$STR_SAH_AGE), linetype="dashed", color="grey30")+
  #ylim(0,10) +
  labs(x="Age at the first incident stroke", fill="Strata", color="Strata") +
  scale_color_hue(direction = -1) + 
  scale_fill_hue(direction = -1) + 
  scale_x_continuous(breaks=seq(10, 90, 10)) +
  theme_classic() 

ggsave(file = str_glue("{fig_path}/hist.str.png"), plot = plot.hist.str, height = 4, width = 5, dpi = 150)
ggsave(file = str_glue("{fig_path}/hist.str.eps"), plot = plot.hist.str, height = 4, width = 5, dpi = 150, device=cairo_ps)
plot.hist.str

```



# Analysis
<br>

## Kaplan meier curves {.tabset}
<br>

A history of at least one APO will be associated with shorter time to first stroke (early stroke)

Stroke vs.  (as binary variable, ever/never). Time zero is considered to be the first recorded birth.

**Model by survfit**

```{r km models}

km.apo <- survfit(Surv(tstart, tstop, STR_SAH) ~ APO2, data=df.str)

survdiff(Surv(tstop, STR_SAH) ~ APO2, data = df.str)

```

### Kaplan meier


```{r}


plot.km.apo <-  
    ggsurvplot(km.apo, fun="event", conf.int=F, censor=F, 
       xlim=c(35,80), ylim=c(0,0.25), break.x.by=10, 
       xlab = "Age, years", size = 0.7, #title = ep, 
       ggtheme = theme_classic(), #palette = c("#00BFC4","#F8766D"), 
       #legend.title = "Complications", 
       legend.labs = c("No APO","1 APO", "2+ APO"),  #legend="right"
      )$plot +
  scale_color_hue(direction = -1) + 
  theme(legend.position= c(0.2,0.8))

# then print
ggsave(file = str_glue("{fig_path}/km.str.apo.png"), plot = plot.km.apo, height = 4, width = 4, dpi = 150)
ggsave(file = str_glue("{fig_path}/km.str.apo.eps"), plot = plot.km.apo, height = 4, width = 4, dpi = 150, device=cairo_ps)
plot.km.apo

```

### log log plot

```{r}


ggsurvplot(km.apo, fun="cloglog", conf.int=F, censor=F, 
       xlim=c(30,80), ylim=c(-7.5,-1),  break.x.by=5,
       xlab = "Age, years", size = 0.7,
       ggtheme = theme_classic(), #palette = c("#00BFC4","#F8766D"), 
       legend.title = "Complications", legend.labs = c("No","1 APO", "2+ APO")
      )$plot+
  scale_color_hue(direction = -1) + 
  theme(legend.position= c(0.2,0.8))


```


## {-}

## Cox model: APO2 vs. STR_SAH


The association between APO and early stroke will be stronger in women with >= 2 pregnancies complicated by APO (dose response).


**Incidence rates**

```{r}

names_ep <- c("STR_SAH", "STR_EXH", "INTRACRA")

lapply(names_ep, function(ep){
  df.str %>%
  select_at(c("APO2", ep)) %>%
  rename(outcome = ep) %>%
  group_by(APO2) %>%
      #Frequency of stroke * 1000
      summarise(inc= mean(outcome)*1000) %>%
  ungroup() %>%
  mutate_at("inc", ~round(., digits=1)) %>% 
  pivot_wider(names_from="APO2", values_from = "inc") %>%
  mutate(names=ep)
}) %>% 
  setNames(names_ep) %>%
  do.call(bind_rows, .) %>%
  rename(`No APO` = "0", `1 APO` = "1", `2+ APO`="2") %>% 
  relocate(names) %>%
  my.kable() %>%
  kable_styling(full_width = F, position = "left")


```

<br>



**Model 1: Unadjusted**

```{r}

my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2")

cx.1 <-   coxph(as.formula(my_formula), data=df.str)


```

<br>

**Model 2: Birth age + Birth year + Parity + Education**


```{r}

covs_tmp2 <- "AGE_FIRST + YEAR_FIRST + PARITY_LAST + EDUC3"
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2}")

cx.2 <- coxph(as.formula(my_formula), data=df.str)

```

<br>




**Model 3a: Model2 + hypertension as time varied covariate**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC + {covs_tmp2}")

cx.3a <- coxph(as.formula(my_formula), data=df.str.tdc)


```

<br>



**Model 3b: Model2 + stroke risk factors**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2} + {dis_covs_f}")

cx.3b <- coxph(as.formula(my_formula), data=df.str)


```

<br>



**Model 4: All covariates**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC +  {covs_tmp2} + {dis_covs_f}")

cx.4 <- coxph(as.formula(my_formula), data=df.str.tdc)

```

<br>


**Table4. Cox models with three level variable**


```{r}

cx_list <- list("cx.1","cx.2","cx.3a", "cx.3b","cx.4")

expos = "APO2"
lapply(cx_list, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()

```  

<br>

### Cox: STR_SAH vs. all exposures

<br>

**Model 1** 

```{r}

names_all_exp <- list("PIH2", "GESTAT_HYPERT", "PRE_OR_ECLAMPSIA","PRETERM", "POOR_FETGRO")

cx1.l <- lapply(names_all_exp, function(expos){
  my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ {expos}")
  coxph(as.formula(my_formula), data=df.str)
}) %>% setNames(names_all_exp)


```

<br>

**Model 4: All covariates**


Adjusted for previous model and disease covariates. Hypertension is excluded.

We exclude BMI and smoking because incomplete data. We will later do sensitivity
analysis regarding this. Instead, obesity diagnosis is included to covariates. 


```{r}

cx4.l <- lapply(names_all_exp, function(expos){
  my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ {expos} +  HT_TDC + {covs_tmp2} + {dis_covs_f}")
  coxph(as.formula(my_formula), data=df.str.tdc)
}) %>% setNames(names_all_exp)


```

<br


**Table 4.** 


```{r}


cx_list <- list("cx1.l","cx4.l")

lapply(cx_list, function(cx_name){
     
    cx <-get(cx_name)
    #cx <- cx1.l
    #cx_name="cx1.l"
    lapply(names_all_exp, function(exp){
      #exp <- "PIH2"
      my_extr_coef(cx[[exp]], "STR_SAH", exp) %>% 
      my_tidy_est() %>% 
      select(title, exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)

    }) %>% setNames(names_all_exp) %>%
      do.call(bind_rows, .)
  
}) %>%  reduce(inner_join, by=c("title","exposure")) %>%
  select(-title) %>%
  my.kable()



```  

<br<


### glm: STR_SAH and age cutoff


<br>

**Model 1** 

```{r}

names_ep_cutoff <- list("STR_45", "STR_55", "STR_65", "STR_SAH") 

glm1.l <- lapply(names_ep_cutoff, function(ep){
  
  my_formula <- str_glue("{ep} ~ APO2")
  glm(as.formula(my_formula),  data=df.str, family = 'binomial')
  
}) %>% setNames(names_ep_cutoff)

```

<br>


**Model 4: All covariates**


Adjusted for previous model and disease covariates.

Baseline age is age at first birth and that is allready used as covariate. 
It would be problematic to adjust by stroke age as data includes also 
individuals without stroke. Therefore we did not add any additiona  'age' 
covariate besides age of first birth. 


```{r}

glm4.l <- lapply(names_ep_cutoff, function(ep){
  
  #age <- str_glue("{ep}_AGE")
  #my_formula <- str_glue("{ep} ~ APO2 + {age} + {covs_tmp2} + HYPTENS_PRE + {dis_covs_f}")
  my_formula <- str_glue("{ep} ~ APO2 + {covs_tmp2} + HYPTENS_PRE + {dis_covs_f}")
  glm(as.formula(my_formula),  data=df.str , family = 'binomial')
  #print(my_formula)
  
}) %>% setNames(names_ep_cutoff)


```

<br>


**Table 3.** 


```{r}

#glm <- glm4.l$STR_65
glm_list <- list("glm1.l","glm4.l")

lapply(glm_list, function(glm_name){
     
    glm <-get(glm_name)
    #glm <- glm4.l
    #glm_name="glm4.l"
    lapply(names_ep_cutoff, function(ep){
      #ep <- "STR_65"
      my_extr_coef_glm(glm[[ep]], ep, "APO2") %>% 
      my_tidy_est() %>% 
      select(title, exposure, est_ci) %>%
      rename(outcome=title) %>%
      rename(!!str_glue("est_ci.{glm_name}") := est_ci)

    }) %>% setNames(names_ep_cutoff) %>%
      do.call(bind_rows, .)
  
}) %>%  reduce(inner_join, by=c("outcome","exposure")) %>%
  mutate(exposure = str_replace(exposure, "APO21", "1 APO"),
         exposure = str_replace(exposure, "APO22", "2+ APO")) %>%
  my.kable()
  

```  


<br>



# Sensitivity analyses{.tabset}



## Exclude multiple


**Exclude if multiple pregnancy**

We include individuals without any multiple pregnancies.
Both FinnGEn/birth registry (NRO_FETUSES) and FinnGen/hospital discharge registry (MULTIP_GES)
based definitions are used.

```{r class.source = 'fold-show'}

df.str.sngl <- df.str %>%  filter(FETUSES_MAX == 1 & MULTIP_GEST ==0)
df.str.tdc.sngl <- df.str.tdc %>%  filter(FETUSES_MAX == 1 & MULTIP_GEST ==0)
```

Number of individuals

```{r class.source = 'fold-show'}
dim(df.str.sngl)[1]
table(df.str.sngl$APO2, df.str.sngl$STR_SAH)
```


**Incidence rates**

```{r}

names_ep <- c("STR_SAH", "STR_EXH", "INTRACRA")

lapply(names_ep, function(ep){
  df.str.sngl %>%
  select_at(c("APO2", ep)) %>%
  rename(outcome = ep) %>%
  group_by(APO2) %>%
      #Frequency of stroke * 1000
      summarise(inc= mean(outcome)*1000) %>%
  ungroup() %>%
  mutate_at("inc", ~round(., digits=1)) %>% 
  pivot_wider(names_from="APO2", values_from = "inc") %>%
  mutate(names=ep)
}) %>% 
  setNames(names_ep) %>%
  do.call(bind_rows, .) %>%
  rename(`No APO` = "0", `1 APO` = "1", `2+ APO`="2") %>% 
  relocate(names) %>%
  my.kable() %>%
  kable_styling(full_width = F, position = "left")


```

<br>



**Model 1: Unadjusted**

```{r}

my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2")

cx.1 <-   coxph(as.formula(my_formula), data=df.str.sngl)


```

<br>

**Model 2: Birth age + Birth year + Parity + Education**


```{r}

covs_tmp2 <- "AGE_FIRST + YEAR_FIRST + PARITY_LAST + EDUC3"
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2}")

cx.2 <- coxph(as.formula(my_formula), data=df.str.sngl)

```

<br>




**Model 3a: Model2 + hypertension as time varied covariate**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC + {covs_tmp2}")

cx.3a <- coxph(as.formula(my_formula), data=df.str.tdc.sngl)


```

<br>



**Model 3b: Model2 + stroke risk factors**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2} + {dis_covs_f}")

cx.3b <- coxph(as.formula(my_formula), data=df.str.sngl)


```

<br>



**Model 4: All covariates**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC +  {covs_tmp2} + {dis_covs_f}")

cx.4 <- coxph(as.formula(my_formula), data=df.str.tdc.sngl)

```

<br>


**Table4. Cox models with three level variable**


```{r}

cx_list <- list("cx.1","cx.2","cx.3a", "cx.3b","cx.4")

expos = "APO2"
lapply(cx_list, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()

```  

<br>




## Exclude SAH

We use FinnGen variable I9_STR that excludes SAH.

```{r}

df.str.nsah      <- tmerge(data1=df.str.tmp,     data2=df.str.tmp, id=FINNGENID, tstart = AGE_FIRST, tstop = STR_AGE)
df.str.tdc.nsah  <- tmerge(data1=df.str.nsah,    data2=df.str.tmp, id=FINNGENID, HT_TDC = tdc(HYPTENS_AGE), STR = event(STR_AGE, STR)) 
```

Number of individuals

```{r class.source = 'fold-show'}
dim(df.str.nsah)[1]
table(df.str.nsah$APO2, df.str.nsah$STR)

```


**Incidence rates**

```{r}

names_ep <- c("STR", "STR_EXH", "INTRACRA")

lapply(names_ep, function(ep){
  df.str.nsah %>%
  select_at(c("APO2", ep)) %>%
  rename(outcome = ep) %>%
  group_by(APO2) %>%
      #Frequency of stroke * 1000
      summarise(inc= mean(outcome)*1000) %>%
  ungroup() %>%
  mutate_at("inc", ~round(., digits=1)) %>% 
  pivot_wider(names_from="APO2", values_from = "inc") %>%
  mutate(names=ep)
}) %>% 
  setNames(names_ep) %>%
  do.call(bind_rows, .) %>%
  rename(`No APO` = "0", `1 APO` = "1", `2+ APO`="2") %>% 
  relocate(names) %>%
  my.kable() %>%
  kable_styling(full_width = F, position = "left")


```

<br>



**Model 1: Unadjusted**

```{r}

my_formula <- str_glue("Surv(tstart,tstop, STR) ~ APO2")

cx.1 <-   coxph(as.formula(my_formula), data=df.str.nsah)


```

<br>

**Model 2: Birth age + Birth year + Parity + Education**


```{r}

covs_tmp2 <- "AGE_FIRST + YEAR_FIRST + PARITY_LAST + EDUC3"
my_formula <- str_glue("Surv(tstart, tstop, STR) ~ APO2 + {covs_tmp2}")

cx.2 <- coxph(as.formula(my_formula), data=df.str.nsah)

```

<br>




**Model 3a: Model2 + hypertension as time varied covariate**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR) ~ APO2 + HT_TDC + {covs_tmp2}")

cx.3a <- coxph(as.formula(my_formula), data=df.str.tdc.nsah)


```

<br>



**Model 3b: Model2 + stroke risk factors**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR) ~ APO2 + {covs_tmp2} + {dis_covs_f}")

cx.3b <- coxph(as.formula(my_formula), data=df.str.nsah)


```

<br>



**Model 4: All covariates**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR) ~ APO2 + HT_TDC +  {covs_tmp2} + {dis_covs_f}")

cx.4 <- coxph(as.formula(my_formula), data=df.str.tdc.nsah)

```

<br>


**Table4. Cox models with three level variable**


```{r}

cx_list <- list("cx.1","cx.2","cx.3a", "cx.3b","cx.4")

expos = "APO2"
lapply(cx_list, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()

```  

<br>


## Fine Gray

Fine Gray model using death and CVD death as competing risk


**Create variables for the Fine Gray model**


```{r}

df.str.fg.tmp <-   df.str.tmp %>%
  mutate(STR_DEATH2 = if_else(STR_SAH == 1, STR_SAH, as.integer(DEATH*2))) %>%
  mutate(STR_DEATH2_AGE = if_else(STR_SAH == 1, STR_SAH_AGE, DEATH_AGE)) %>%
  mutate(STR_DEATH2 = as.factor(STR_DEATH2)) %>%
  mutate(STR_DEATH2 = recode(STR_DEATH2, `0`="censor", `1`="stroke", `2`="death")) %>%  #select(STR_DEATH2) %>% summary()
  mutate(STR_CVDDEATH2 = if_else(STR_SAH == 1, STR_SAH, as.integer(CVD_DEATH*2))) %>%
  mutate(STR_CVDDEATH2_AGE = if_else(STR_SAH == 1, STR_SAH_AGE, CVD_DEATH_AGE)) %>%
  mutate(STR_CVDDEATH2 = as.factor(STR_CVDDEATH2)) %>%
  mutate(STR_CVDDEATH2 = recode(STR_CVDDEATH2, `0`="censor", `1`="stroke", `2`="cvddeath")) %>%  
  select(FINNGENID, AGE_FIRST, YEAR_FIRST, PARITY_LAST, EDUC3, APO2, STR_SAH, STR_SAH_AGE, DEATH, DEATH_AGE, CVD_DEATH, CVD_DEATH_AGE,
         STR_DEATH2, STR_DEATH2_AGE, STR_CVDDEATH2, STR_CVDDEATH2_AGE, HYPTENS, HYPTENS_AGE,   all_of(dis_covs)) %>%
  as_tibble() #%>% 
  #slice(1:110) 
  #slice(1:100000)


df.str.fg      <- tmerge(data1=df.str.fg.tmp, data2=df.str.fg.tmp, id=FINNGENID, tstart = AGE_FIRST, tstop = STR_DEATH2_AGE)
df.str.tdc.fg  <- tmerge(data1=df.str.fg,     data2=df.str.fg.tmp, id=FINNGENID, HT_TDC = tdc(HYPTENS_AGE), STR_DEATH2 = event(STR_DEATH2_AGE, STR_DEATH2)) 
df.strc.fg      <- tmerge(data1=df.str.fg.tmp,  data2=df.str.fg.tmp, id=FINNGENID, tstart = AGE_FIRST, tstop = STR_CVDDEATH2_AGE)
df.strc.tdc.fg  <- tmerge(data1=df.strc.fg,     data2=df.str.fg.tmp, id=FINNGENID, HT_TDC = tdc(HYPTENS_AGE), STR_CVDDEATH2 = event(STR_CVDDEATH2_AGE, STR_CVDDEATH2)) 
#  select(FINNGENID, AGE_FIRST, YEAR_FIRST, PARITY_LAST, EDUC3, APO2, STR_SAH, STR_SAH_AGE, DEATH, DEATH_AGE, 
#         STR_DEATH2, STR_DEATH2_AGE, HYPTENS, HYPTENS_AGE, HT_TDC, tstart, tstop, id)

fg.str       <- finegray(Surv(tstart, tstop, STR_DEATH2) ~ ., data=df.str.fg,     etype="stroke", id=id)
fg.death     <- finegray(Surv(tstart, tstop, STR_DEATH2) ~ ., data=df.str.fg,     etype="death",  id=id)
fg.str.tdc   <- finegray(Surv(tstart, tstop, STR_DEATH2) ~ ., data=df.str.tdc.fg, etype="stroke", id=id)
fg.death.tdc <- finegray(Surv(tstart, tstop, STR_DEATH2) ~ ., data=df.str.tdc.fg, etype="death",  id=id)

fg.cstr       <- finegray(Surv(tstart, tstop, STR_CVDDEATH2) ~ ., data=df.strc.fg,     etype="stroke", id=id)
fg.cdeath     <- finegray(Surv(tstart, tstop, STR_CVDDEATH2) ~ ., data=df.strc.fg,     etype="cvddeath",  id=id)
fg.cstr.tdc   <- finegray(Surv(tstart, tstop, STR_CVDDEATH2) ~ ., data=df.strc.tdc.fg, etype="stroke", id=id)
fg.cdeath.tdc <- finegray(Surv(tstart, tstop, STR_CVDDEATH2) ~ ., data=df.strc.tdc.fg, etype="cvddeath",  id=id)

```

Number of individuals

```{r class.source = 'fold-show'}
dim(df.str.fg)[1]
table(df.str.fg$STR_DEATH2)
table(df.str.fg$APO2, df.str.fg$STR_DEATH2)
table(df.str.fg$STR_CVDDEATH2)

```


**Model 1: Unadjusted**

```{r}
#cx1.test.str   <- coxph(Surv(fgstart, fgstop, fgstatus) ~ APO2, data=fg.str, weight=fgwt)

my_formula <- "Surv(fgstart, fgstop, fgstatus) ~ APO2"
cxfg.1   <- coxph(as.formula(my_formula), data=fg.str,   weight=fgwt)
cxfg.1.d <- coxph(as.formula(my_formula), data=fg.death, weight=fgwt)
cxfg.1.c <- coxph(as.formula(my_formula), data=fg.cstr,   weight=fgwt)

```

<details><summary>**Fine-Gray: Death**</summary>

Compeating stroke and death compared. For death the results are not statistically significant.

```{r, fig.width=6, fig.height=5}

 my_extr_coef(cxfg.1, "stroke", "APO2") %>% 
  my_tidy_est() %>%
  select(title, exposure, est_ci, pval) %>% 
  my.kable()
 
my_extr_coef(cxfg.1.d, "death", "APO2") %>% 
  my_tidy_est() %>%
  select(title, exposure, est_ci, pval) %>%
  my.kable()


kmfg.apo.1 <- survfit(Surv(tstop, STR_DEATH2) ~ APO2, data=df.str.fg, id=id)

plot(kmfg.apo.1, col=c(4,3,2,4,3,2), lty=c(1,1,1,2,2,2),
     xlab = "Age, Years", ylab="Probability in State",
     xlim = c(40,90), lwd=1.5) 
legend("topleft", c("Stroke:APO=0",  "Stroke:APO=1", "Stroke:APO=2", "Death:APO=0",  "Death:APO=1", "Death:APO=2"),
       col=c(4,3,2,4,3,2), lty=c(1,1,1,2,2,2), lwd=1.5, bty="n")


```


</details>

**Model 2: Birth age + Birth year + Parity + Education**


```{r}

covs_tmp2 <- "AGE_FIRST + YEAR_FIRST + PARITY_LAST + EDUC3"
my_formula <- str_glue("Surv(fgstart, fgstop, fgstatus) ~ APO2 + {covs_tmp2}")

cxfg.2   <- coxph(as.formula(my_formula), data=fg.str,  weight=fgwt)
cxfg.2.c <- coxph(as.formula(my_formula), data=fg.cstr, weight=fgwt)

```

<br>




**Model 3a: Model2 + hypertension as time varied covariate**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(fgstart, fgstop, fgstatus) ~ APO2 + HT_TDC + {covs_tmp2}")

cxfg.3a   <- coxph(as.formula(my_formula), data=fg.str.tdc,  weight=fgwt)
cxfg.3a.c <- coxph(as.formula(my_formula), data=fg.cstr.tdc, weight=fgwt)

```

<br>



**Model 3b: Model2 + stroke risk factors**

```{r}


dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(fgstart, fgstop, fgstatus) ~ APO2 + {covs_tmp2} + {dis_covs_f}")

cxfg.3b   <- coxph(as.formula(my_formula), data=fg.str,  weight=fgwt)
cxfg.3b.c <- coxph(as.formula(my_formula), data=fg.cstr, weight=fgwt)

```

<br>



**Model 4: All covariates**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(fgstart, fgstop, fgstatus) ~ APO2 + HT_TDC +  {covs_tmp2} + {dis_covs_f}")

cxfg.4   <- coxph(as.formula(my_formula),data=fg.str.tdc,  weight=fgwt)
cxfg.4.c <- coxph(as.formula(my_formula),data=fg.cstr.tdc, weight=fgwt)

```

<br>


**Cox models - death as competing event**


```{r}

cx_list <- list("cxfg.1","cxfg.2","cxfg.3a", "cxfg.3b","cxfg.4")

expos = "APO2"
lapply(cx_list, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()

```  


**Cox models - CVD death as competing event**


```{r}

cx_list.c <- list("cxfg.1.c","cxfg.2.c","cxfg.3a.c", "cxfg.3b.c","cxfg.4.c")

expos = "APO2"
lapply(cx_list.c, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()


```  

<br>



<br>




## Include BMI


**Exclude if no smoking status during pregnancy**

```{r}

df.str.bmi <- df.str %>%  filter(!is.na(BMI))
df.str.tdc.bmi <- df.str.tdc %>%  filter(!is.na(BMI))  
```

Number of individuals

```{r class.source = 'fold-show'}

dim(df.str.bmi)[1]
table(df.str.bmi$APO2, df.str.bmi$STR_SAH)

  
```


**Incidence rates**

```{r}

names_ep <- c("STR_SAH", "STR_EXH", "INTRACRA")

lapply(names_ep, function(ep){
  df.str.bmi %>%
  select_at(c("APO2", ep)) %>%
  rename(outcome = ep) %>%
  group_by(APO2) %>%
      #Frequency of stroke * 1000
      summarise(inc= mean(outcome)*1000) %>%
  ungroup() %>%
  mutate_at("inc", ~round(., digits=1)) %>% 
  pivot_wider(names_from="APO2", values_from = "inc") %>%
  mutate(names=ep)
}) %>% 
  setNames(names_ep) %>%
  do.call(bind_rows, .) %>%
  rename(`No APO` = "0", `1 APO` = "1", `2+ APO`="2") %>% 
  relocate(names) %>%
  my.kable() %>%
  kable_styling(full_width = F, position = "left")

#median(df.str$YEAR_FIRST)
#median(df.str.bmi$YEAR_FIRST)

```

<br>



**Model 1: Unadjusted**

```{r}

my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2")

cx.1 <-   coxph(as.formula(my_formula), data=df.str.bmi)


```

<br>

**Model 2: Birth age + Birth year + Parity + Education**


```{r}

covs_tmp2 <- "AGE_FIRST + YEAR_FIRST + PARITY_LAST + EDUC3"
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2}")

cx.2 <- coxph(as.formula(my_formula), data=df.str.bmi)

```

<br>




**Model 3a: Model2 + hypertension as time varied covariate**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC + {covs_tmp2}")

cx.3a <- coxph(as.formula(my_formula), data=df.str.tdc.bmi)


```

<br>



**Model 3b: Model2 + stroke risk factors**

```{r}

dis_covs_bmi_f <- str_flatten(c("BMI", dis_covs[dis_covs!="OBESITY_PRE"]), collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2} + {dis_covs_bmi_f}")

cx.3b <- coxph(as.formula(my_formula), data=df.str.bmi)


```

<br>



**Model 4: All covariates**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC +  {covs_tmp2} + {dis_covs_bmi_f}")

cx.4 <- coxph(as.formula(my_formula), data=df.str.tdc.bmi)

```

<br>


**Table4. Cox models with three level variable**


```{r}

cx_list <- list("cx.1","cx.2","cx.3a", "cx.3b","cx.4")

expos = "APO2"
lapply(cx_list, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()

```  

<br>





## Include smoking during pregnancy


**Exclude if no smoking status during pregnancy**

```{r}

df.str.psmo <- df.str %>%  filter(!is.na(PSMOKED))
df.str.tdc.psmo <- df.str.tdc %>%  filter(!is.na(PSMOKED))  
```

Number of individuals

```{r class.source = 'fold-show'}

dim(df.str.psmo)[1]
table(df.str.psmo$APO2, df.str.psmo$STR_SAH)

  
```


**Incidence rates**

```{r}

names_ep <- c("STR_SAH", "STR_EXH", "INTRACRA")

lapply(names_ep, function(ep){
  df.str.psmo %>%
  select_at(c("APO2", ep)) %>%
  rename(outcome = ep) %>%
  group_by(APO2) %>%
      #Frequency of stroke * 1000
      summarise(inc= mean(outcome)*1000) %>%
  ungroup() %>%
  mutate_at("inc", ~round(., digits=1)) %>% 
  pivot_wider(names_from="APO2", values_from = "inc") %>%
  mutate(names=ep)
}) %>% 
  setNames(names_ep) %>%
  do.call(bind_rows, .) %>%
  rename(`No APO` = "0", `1 APO` = "1", `2+ APO`="2") %>% 
  relocate(names) %>%
  my.kable() %>%
  kable_styling(full_width = F, position = "left")

#median(df.str$YEAR_FIRST)
#median(df.str.psmo$YEAR_FIRST)

```

<br>



**Model 1: Unadjusted**

```{r}

my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2")

cx.1 <-   coxph(as.formula(my_formula), data=df.str.psmo)


```

<br>

**Model 2: Birth age + Birth year + Parity + Education**


```{r}

covs_tmp2 <- "AGE_FIRST + YEAR_FIRST + PARITY_LAST + EDUC3"
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2}")

cx.2 <- coxph(as.formula(my_formula), data=df.str.psmo)

```

<br>




**Model 3a: Model2 + hypertension as time varied covariate**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC + {covs_tmp2}")

cx.3a <- coxph(as.formula(my_formula), data=df.str.tdc.psmo)


```

<br>



**Model 3b: Model2 + stroke risk factors**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2} + PSMOKED + {dis_covs_f}")

cx.3b <- coxph(as.formula(my_formula), data=df.str.psmo)


```

<br>



**Model 4: All covariates**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC +  {covs_tmp2} + PSMOKED + {dis_covs_f}")

cx.4 <- coxph(as.formula(my_formula), data=df.str.tdc.psmo)

```

<br>


**Table4. Cox models with three level variable**


```{r}

cx_list <- list("cx.1","cx.2","cx.3a", "cx.3b","cx.4")

expos = "APO2"
lapply(cx_list, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()

```  

<br>

## Include smoking


**Exclude if no smoking status**

```{r}

df.str.smo <- df.str %>%  filter(!is.na(SMOKED))
df.str.tdc.smo <- df.str.tdc %>%  filter(!is.na(SMOKED))  
```

Number of individuals

```{r class.source = 'fold-show'}

dim(df.str.smo)[1]
table(df.str.smo$APO2, df.str.smo$STR_SAH)

  
```


**Incidence rates**

```{r}

names_ep <- c("STR_SAH", "STR_EXH", "INTRACRA")

lapply(names_ep, function(ep){
  df.str.smo %>%
  select_at(c("APO2", ep)) %>%
  rename(outcome = ep) %>%
  group_by(APO2) %>%
      #Frequency of stroke * 1000
      summarise(inc= mean(outcome)*1000) %>%
  ungroup() %>%
  mutate_at("inc", ~round(., digits=1)) %>% 
  pivot_wider(names_from="APO2", values_from = "inc") %>%
  mutate(names=ep)
}) %>% 
  setNames(names_ep) %>%
  do.call(bind_rows, .) %>%
  rename(`No APO` = "0", `1 APO` = "1", `2+ APO`="2") %>% 
  relocate(names) %>%
  my.kable() %>%
  kable_styling(full_width = F, position = "left")

#median(df.str$YEAR_FIRST)
#median(df.str.smo$YEAR_FIRST)

```

<br>



**Model 1: Unadjusted**

```{r}

my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2")

cx.1 <-   coxph(as.formula(my_formula), data=df.str.smo)


```

<br>

**Model 2: Birth age + Birth year + Parity + Education**


```{r}

covs_tmp2 <- "AGE_FIRST + YEAR_FIRST + PARITY_LAST + EDUC3"
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2}")

cx.2 <- coxph(as.formula(my_formula), data=df.str.smo)

```

<br>




**Model 3a: Model2 + hypertension as time varied covariate**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC + {covs_tmp2}")

cx.3a <- coxph(as.formula(my_formula), data=df.str.tdc.smo)


```

<br>



**Model 3b: Model2 + stroke risk factors**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ") 
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + {covs_tmp2} + SMOKED + {dis_covs_f}")

cx.3b <- coxph(as.formula(my_formula), data=df.str.smo)


```

<br>



**Model 4: All covariates**

```{r}

dis_covs_f <- str_flatten(dis_covs, collapse=" + ")
my_formula <- str_glue("Surv(tstart, tstop, STR_SAH) ~ APO2 + HT_TDC +  {covs_tmp2} + SMOKED + {dis_covs_f}")

cx.4 <- coxph(as.formula(my_formula), data=df.str.tdc.smo)

```

<br>


**Table4. Cox models with three level variable**


```{r}

cx_list <- list("cx.1","cx.2","cx.3a", "cx.3b","cx.4")

expos = "APO2"
lapply(cx_list, function(cx_name){

    cx <-get(cx_name)
    my_extr_coef(cx, expos, expos) %>% 
      my_tidy_est() %>% 
      select(exposure, est_ci) %>%
      rename(!!str_glue("est_ci.{cx_name}") := est_ci)
    
}) %>%  reduce(inner_join, by="exposure") %>%
  my.kable()

```  

<br>



# {-}